pkgname=directfb
pkgver=1.7.7
pkgrel=1

pkgdesc="Library for hw graphics acceleration, input dev, windowing system on top of the Linux fb device"
arch="armhf"

url="http://www.directfb.org"
license="LGPL"
makedepends="zlib-dev freetype-dev libdrm-dev mesa-dev libpng-dev perl"
depends="libgcc libjpeg sdl libpng freetype libdrm mesa"

subpackages="$pkgname-doc"

source="
    http://sources.webos-ports.org/downloads/DirectFB-$pkgver.tar.gz
    0001-directfb-fix-musl-compile.patch
    0002-Fix-musl-PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP-comp.patch
    0003-remove-set-gamma-ramp.patch
    0004-disable-fusion_dispatch.patch"

sha1sums="205d824906906303db9b096cc2d3bea0662e8860"


prepare() {

    cd ${srcdir}/DirectFB-${pkgver}

    local _patch_failed=

    # first apply patches in specified order
    for i in $source; do
        case $i in
            *.patch)
            msg "Applying $i..."
            if ! patch -s -p1 -N -i "$srcdir"/$i; then
                echo $i >>failed
                    _patch_failed=1
            fi
            ;;
        esac
    done

    if ! [ -z "$_patch_failed" ]; then
        error "The following patches failed:"
        cat failed
        return 1
    fi
}

build() {
    cd ${srcdir}/DirectFB-${pkgver}
    ./configure --prefix=/usr --sysconfdir=/etc --enable-static \
                         --disable-zlib --disable-x11 --enable-fbdev --disable-vnc --disable-osx \
                         --disable-video4linux \
                         --disable-mesa --enable-drmkms --enable-freetype \
                         --with-inputdrivers=input_hub,keyboard,linuxinput,ps2mouse,serialmouse \
                         --with-gfxdrivers=omap --disable-multi --disable-multi-kernel
                         make
}

package() {
    cd ${srcdir}/DirectFB-${pkgver}
    make DESTDIR="${pkgdir}" install
}
sha512sums="c9ce8ffe7d7d17b0351da6a031db7345f31fb7112545f9352834ad33225a93e6284ef0e576ef5fc595bc9060c1756051322fa20f7b5b3444b68d7f05bd1ba494  DirectFB-1.7.7.tar.gz
d9325c228a534d2d2b93b4dacf896fc12c703b9e08adf1ae8f5baea2a0ed5c4d07d56b8bc63dc605362f093624eab40686b43028ef15a78a01bc10e5f41c16bc  0001-directfb-fix-musl-compile.patch
ed3bf9bf76616174aca6ae92fd9873c9452951b8a2acb60e1ccbbea0c4a7c9766e510899bc8f58c24dd5888c1e7e1f0a0d4a823f0bd9e03a4c9d2a54fb714221  0002-Fix-musl-PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP-comp.patch
bd1d0738c48411e8e065b8a250c1b31334ac65b26a8f6c91d5ad167a4d8fdac1de862c05940567e48fc740dd45fbecf906ebdfbff63420d4f86bee7a3a0746ee  0003-remove-set-gamma-ramp.patch
d68002702f3521a71405bb403b874dced5b123a2de037c9eb05667123a578c0e9a9f13a822fd8d77e31a83f1e1cc8df1d8511f7d2f427688d5ef6ae0fff448c5  0004-disable-fusion_dispatch.patch"
